#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <time.h>

#define  FLAG_COST 13370000
#define  FLAG      "bzhctf{BaCK_To_TeH_FuTuRe!}"

struct human {
	time_t   time;
	unsigned money;
};

int readInput()
{
	char buffer[64];

	fgets(buffer, sizeof(buffer), stdin);
	return atoi(buffer);
}

void sell(struct human *me)
{
	int choice;

	printf("Rate: 1 minute = $5\n");
	printf("Minutes to sell> ");

	choice = readInput();

	if(choice < 0 || choice * 60 > me->time - time(NULL)) {
		puts("Nice try...");
		return;
	}

	me->time  -= 60 * choice;
	me->money += 5  * choice;
}

void buy(struct human *me)
{
	int choice;

	printf("Rate: $10 = 1 minute\n");
	printf("Minutes to buy> ");

	choice = readInput();

	if(choice < 0 || (unsigned)choice * 10 > me->money) {
		puts("Nice try...");
		return;
	}

	me->money -= 10 * choice;
	me->time  += 60 * choice;
}

void flag(struct human *me)
{
	if(me->money < FLAG_COST) {
		puts("Flags are not for poor people");
		printf("You need %u to buy it\n", FLAG_COST);
		return;
	}

	puts("Wait what?");
	puts(FLAG);
	exit(0);
}

int main(int argc, char *argv[])
{
	struct human me;
	int    remaining;

	unsigned int h, m, s;
	int      choice;

	/* stfu */
	(void)argc;
	(void)argv;

	/* Remote */
	setvbuf(stdout, 0, _IONBF, 0);

	/* Prepare me */
	me.time = time(NULL) + 5 * 60;
	me.money = 2000;

	puts("Let's play a game:");
	puts("I gave you:");
	puts("- $2,000");
	puts("- 5 minutes to live");
	puts("");
	puts("You can trade money with time and vice versa");
	puts("You can buy a flag for $13,370,000");
	puts("Get rich, or die trying");
	puts("Think fast. Time is money");
	puts("");

	while(0 < (remaining = me.time - time(NULL))) {

		h = remaining / 3600;
		m = (remaining % 3600) / 60;
		s = remaining % 60;

		puts("");
		printf("Time before death: ");
		printf("%02u:%02u:%02u\n", h, m, s);
		printf("Money: %u\n", me.money);

		puts("0) exit");
		puts("1) sell time");
		puts("2) buy time");
		puts("3) buy flag");
		printf("> ");

		choice = readInput();
		puts("");

		if(0 == choice)
			break;

		if(1 == choice)
			sell(&me);

		if(2 == choice)
			buy(&me);

		if(3 == choice)
			flag(&me);
	}

	puts("Game over");
}
