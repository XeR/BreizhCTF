#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>

#define GADGETS_START ((void*)gadget_00)
#define GADGETS_STOP  ((void*)callMe)

int gadget_00(void) { return 3445998369; }
int gadget_01(void) { return  658293589; }
int gadget_02(void) { return 3060646882; }
int gadget_03(void) { return  508871575; }
int gadget_04(void) { return  866173697; }
int gadget_05(void) { return 3995648815; }
int gadget_06(void) { return 2567750441; }
int gadget_07(void) { return 3917726690; }
int gadget_08(void) { return 3501442035; }
int gadget_09(void) { return 1037288376; }
int gadget_10(void) { return 1191560093; }
int gadget_11(void) { return  550618032; }
int gadget_12(void) { return 2104148852; }
int gadget_13(void) { return 3207971816; }
int gadget_14(void) { return  700040080; }
int gadget_15(void) { return 1986970474; }
int gadget_16(void) { return 2445984663; }
int gadget_17(void) { return  518570958; }
int gadget_18(void) { return 3634283327; }
int gadget_19(void) { return  793232240; }
int gadget_20(void) { return  676709309; }
int gadget_21(void) { return 3459498891; }
int gadget_22(void) { return 2436481809; }
int gadget_23(void) { return  839762842; }
int gadget_24(void) { return 1140966372; }
int gadget_25(void) { return  803128228; }
int gadget_26(void) { return  231719772; }
int gadget_27(void) { return 3843015580; }
int gadget_28(void) { return 1172030376; }
int gadget_29(void) { return 1016316870; }
int gadget_30(void) { return  827507554; }
int gadget_31(void) { return 1723057130; }
int gadget_32(void) { return 1353499632; }
int gadget_33(void) { return 2337719156; }
int gadget_34(void) { return 1121567517; }
int gadget_35(void) { return 3045770095; }
int gadget_36(void) { return 3624780676; }
int gadget_37(void) { return 2895168450; }
int gadget_38(void) { return  997573480; }
int gadget_39(void) { return 3409167257; }
int gadget_40(void) { return 3464479662; }
int gadget_41(void) { return  176079823; }
int gadget_42(void) { return 3418538897; }
int gadget_43(void) { return 3884499931; }
int gadget_44(void) { return  332645359; }
int gadget_45(void) { return 2167587698; }
int gadget_46(void) { return 1461634002; }
int gadget_47(void) { return  138658635; }
int gadget_48(void) { return 3984704277; }
int gadget_49(void) { return 1360446449; }
int gadget_50(void) { return 3459761060; }
int gadget_51(void) { return  462013197; }
int gadget_52(void) { return 2321466204; }
int gadget_53(void) { return  260883390; }
int gadget_54(void) { return 2797126443; }
int gadget_55(void) { return 3310011153; }
int gadget_56(void) { return 1439941525; }
int gadget_57(void) { return 1367852004; }
int gadget_58(void) { return 3210199883; }
int gadget_59(void) { return  859095904; }
int gadget_60(void) { return 1563214689; }
int gadget_61(void) { return  407946124; }
int gadget_62(void) { return 2622341934; }
int gadget_63(void) { return 3692479478; }
int gadget_64(void) { return  875479959; }
int gadget_65(void) { return 3123364726; }
int gadget_66(void) { return 3016606537; }
int gadget_67(void) { return 2829894499; }
int gadget_68(void) { return 2647573331; }
int gadget_69(void) { return   67093353; }
int gadget_70(void) { return 2465842041; }
int gadget_71(void) { return  968868696; }
int gadget_72(void) { return  420725595; }
int gadget_73(void) { return 2321793844; }
int gadget_74(void) { return 1146536955; }
int gadget_75(void) { return 2878718945; }
int gadget_76(void) { return 4060136294; }
int gadget_77(void) { return 3587163025; }
int gadget_78(void) { return 3833250629; }
int gadget_79(void) { return  404538328; }
int gadget_80(void) { return 1595065199; }
int gadget_81(void) { return  454017815; }
int gadget_82(void) { return  670811090; }
int gadget_83(void) { return 3507274589; }
int gadget_84(void) { return 4227122076; }
int gadget_85(void) { return 2320614307; }
int gadget_86(void) { return 2656420674; }
int gadget_87(void) { return 4156277539; }
int gadget_88(void) { return 3478635319; }
int gadget_89(void) { return 2413085508; }
int gadget_90(void) { return 1069073388; }
int gadget_91(void) { return  892519312; }
int gadget_92(void) { return 4283417491; }
int gadget_93(void) { return 1074119655; }
int gadget_94(void) { return 1021756328; }
int gadget_95(void) { return 2088027060; }
int gadget_96(void) { return 2859123470; }
int gadget_97(void) { return  786023376; }
int gadget_98(void) { return 1530905414; }
int gadget_99(void) { return  405717765; }

void callMe()
{
	int    fd;
	char   buffer[512];
	size_t size;

	fd   = open(".flag", O_RDONLY);
	size = read(fd, buffer, sizeof(buffer) - 1);
	buffer[size] = 0;

	printf("Congratulations! Flag is %s\n", buffer);
	exit(EXIT_SUCCESS);
}

int main(void)
{
	uint32_t* overwrite;
	size_t i;

	puts("Welcome to Breizh CTF's ROP simulator!");
	puts("You are allowed to use a bunch of randomly-generated gadgets.");
	puts("You are NOT allowed to jump elsewhere.");


	/* Determine return address */
	overwrite = &overwrite + 9;

	puts("");
	printf("Return address: %08X\n", overwrite);
	printf("GADGETS_START:  %08X\n", GADGETS_START);
	printf("GADGETS_STOP:   %08X\n", GADGETS_STOP);
	puts("");

	puts("Please, enter gadgets adresses in hex");

	i = 0;
	while(fscanf(stdin, "%08x", &(overwrite[i])) != EOF) {
		if((void*)overwrite[i] < GADGETS_START) {
			fprintf(stderr, "%08X is too low\n", overwrite[i]);
			abort();
		}

		if((void*)overwrite[i] >= GADGETS_STOP) {
			fprintf(stderr, "%08X is too high\n", overwrite[i]);
			abort();
		}

		i++;
	}

	printf("Size of ROP: %d\n", i);
	printf("Good luck. (%08X)\n", *overwrite);

	return EXIT_SUCCESS;
}
