#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>

#define  BUFFER_SIZE 512

static const unsigned char key[] = "SYfTHH92GZkCepE953TzfBrSyzRSqNx7";

void callMe()
{
	int    fd;
	char   buffer[512];
	size_t size;

	fd   = open(".flag", O_RDONLY);
	size = read(fd, buffer, sizeof(buffer) - 1);
	buffer[size] = 0;

	printf("Congratulations! Flag is %s\n", buffer);
	exit(EXIT_SUCCESS);
}

void printBanner(char *arg)
{
	printf(
		"       ██╗   ██╗ ██████╗ ██╗      ██████╗ " "\n"
		"       ╚██╗ ██╔╝██╔═══██╗██║     ██╔═══██╗" "\n"
		"        ╚████╔╝ ██║   ██║██║     ██║   ██║" "\n"
		"         ╚██╔╝  ██║   ██║██║     ██║   ██║" "\n"
		"          ██║   ╚██████╔╝███████╗╚██████╔╝" "\n"
		"          ╚═╝    ╚═════╝ ╚══════╝ ╚═════╝ " "\n"
		" ██████╗██████╗ ██╗   ██╗██████╗ ████████╗ ██████╗ " "\n"
		"██╔════╝██╔══██╗╚██╗ ██╔╝██╔══██╗╚══██╔══╝██╔═══██╗" "\n"
		"██║     ██████╔╝ ╚████╔╝ ██████╔╝   ██║   ██║   ██║" "\n"
		"██║     ██╔══██╗  ╚██╔╝  ██╔═══╝    ██║   ██║   ██║" "\n"
		"╚██████╗██║  ██║   ██║   ██║        ██║   ╚██████╔╝" "\n"
		" ╚═════╝╚═╝  ╚═╝   ╚═╝   ╚═╝        ╚═╝    ╚═════╝ " "\n"
		"as a service: life is too short to learn crypto.\n"
		"\n"
		"Usage: %s <message>\n"
		"Crypts a string with strong a 128-bit secure key\n"
		"\n"
		"Hide your sensitive data from the prying eyes!\n", arg);
}

void xorStr(char* str, size_t strs, const char* k, size_t ks)
{
	size_t i;

	for(i = 0; i < strs; i++)
		str[i] ^= k[i % ks];
}

unsigned char* secureCrypt(unsigned char *buffer, size_t size)
{
	xorStr(buffer, size, key, sizeof(key) - 1);
	return buffer;
}

int main(int argc, char* argv[])
{
	char buffer[BUFFER_SIZE];

	if(argc != 2) {
		printBanner(argv[0]);
		return EXIT_FAILURE;
	}

	strncpy(buffer, argv[1], sizeof(buffer));
	printf(secureCrypt(buffer, strlen(buffer)));

	return EXIT_SUCCESS;
}
