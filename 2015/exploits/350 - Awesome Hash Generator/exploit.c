#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>

#include <openssl/md4.h>
#include <openssl/md5.h>

#include <openssl/sha.h>

#define  BUFFER_LENGTH 0x1000

#define  print_hash(name, hash, var) \
	hash(String, length, var);       \
	bin2hex(hex, var, sizeof(var));  \
	printf("%-10s %s\n", name, hex);

/**
 * I wonder what's the point of this function !
 */
int
godGift()
{
	return 0x050f58;
}

/**
 * Function called to convert an integer to base 16
 *
 * @param  int  byte Half byte to convert (0x00..0x0F)
 * @return char Hex representation of this byte '0'..'F'
 */
char
bin2hex_half(int byte)
{
	return byte < 0x0A ? byte + '0': byte - 0x0A + 'A';
}

/**
 * Function called to print the hex representation of a binary string
 *
 * @param char*  output Empty string of size 2 * length + 1
 * @param char*  input  Binary string
 * @param size_t length Size of input
 */

void
bin2hex(char* output, const char* input, size_t length)
{
	unsigned int i;

	for(i = 0; i < length; i++) {
		output[i * 2 + 0] = bin2hex_half((input[i] >> 4) & 0x0F);
		output[i * 2 + 1] = bin2hex_half((input[i] >> 0) & 0x0F);
	}

	output[i * 2] = 0;
}

/**
 * Function called to hash a string, and print it
 *
 * @param char*  String String to hash
 * @param size_t length Length of String
 */
void
hashAndPrint(char* String, size_t length)
{
	char hex[SHA512_DIGEST_LENGTH * 2 + 1];

	char md4[MD4_DIGEST_LENGTH];
	char md5[MD5_DIGEST_LENGTH];

	char sha1[SHA_DIGEST_LENGTH];
	char sha224[SHA224_DIGEST_LENGTH];
	char sha256[SHA256_DIGEST_LENGTH];
	char sha384[SHA384_DIGEST_LENGTH];
	char sha512[SHA512_DIGEST_LENGTH];

	printf("Hash for %s:\n", String);

	print_hash("MD4", MD4, md4);
	print_hash("MD5", MD5, md5);

	print_hash("SHA1",   SHA1,  sha1);
	print_hash("SHA224", SHA224, sha224);
	print_hash("SHA256", SHA256, sha256);
	print_hash("SHA384", SHA384, sha384);
	print_hash("SHA512", SHA512, sha512);
}

/**
 * Function called to read from a specific file descriptior
 *
 * @param  int    fd     File descriptor
 * @param  char*  buffer Output buffer
 * @param  size_t length length of buffer
 * @return size of string written in buffer
 */
ssize_t
readFromFd(int fd, char* buffer, size_t length)
{
	ssize_t size;
	
	size = read(fd, buffer, length);

	if(buffer[size - 1] == '\n')
		size--;

	buffer[size] = 0;

	return size;
}

/**
 * Function called to read user input. It hashes right after.
 *
 * @param  FILE* stream to read
 * @return 0 if stream is closed. 1 otherwise.
 */
int
askUserAndPrint(FILE* stream)
{
	char buffer[BUFFER_LENGTH];

#ifdef DEBUG
	fprintf(stderr, "Buffer: %p..%p\n", buffer, &buffer[BUFFER_LENGTH]);
#endif

	if(!readFromFd(fileno(stream), buffer, sizeof(buffer)))
		return 0;

	hashAndPrint(buffer, strlen(buffer));
	return 1;
}

/**
 * This program calculates hash from user input
 *
 * @author XeR
 */

int
main(int argc, char* argv[])
{
#ifdef DEBUG
	fprintf(stderr, "Last compilation: %s %s\n", __DATE__, __TIME__);
	hashAndPrint("Lorem ipsum dolor sit amet", 6);
#endif

	puts("Welcome to my awesome hash generator!");
	puts("Enter strings to hash, and I will hash it for you");
	puts("Press ctrl-d to quit at any time!");

	while(askUserAndPrint(stdin));

	return EXIT_SUCCESS;
}
