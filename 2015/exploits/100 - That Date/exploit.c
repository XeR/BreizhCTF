#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

#define  MAX_LENGTH 256


/**
 * Function called to show usage
 * It writes how to use this software, and some examples.
 *
 * @param  char* argv0 Absolute, or relative program name
 * @return EXIT_FAILURE
 */
int
showUsage(char* argv0)
{
	fprintf(stderr, "Usage: %s <format>\n", argv0);
	fprintf(stderr, "Example: %s \"%%H:%%M:%%S %%d/%%m/%%y\"\n", argv0);
	fprintf(stderr, "Prints when the flag was read.\n");

	return EXIT_FAILURE;
}

/**
 * Checks if string contains \ or "
 * returns 0 if it does not, 1 if it does
 * supposedly faster than strchr if a match is found.
 *
 * @param  char* string String to check
 * @return 1 if the string is safe, 0 otherwise.
 */
int
checkArg(const char* string)
{
	unsigned int i;
	i = 0;
	
	while(string[i]) {
		if(string[i] == '\\' || string[i] == '"' || string[i] == '$')
			return 0;

		i++;
	}

	return 1;
}

/**
 * This program tells when was the last time someone got the flag.
 *
 * @author XeR
 */

int
main(int argc, char* argv[])
{
	char command[MAX_LENGTH];

#ifdef DEBUG
	fprintf(stderr, "Last compilation: %s %s\n", __DATE__, __TIME__);
#endif

	if(argc > 2)
		return showUsage(argv[0]);

	sprintf(command, "/bin/date -d \"@$(/usr/bin/stat flag -c %%X)\"");

	if(argc == 2) {
		if(strlen(command) + strlen(argv[1]) + 4 > sizeof(command)) {
			fprintf(stderr, "String is too long.\n");
			return EXIT_FAILURE;
		}

		if(!checkArg(argv[1])) {
			fprintf(stderr, "Format probably contains an injection.\n");
			return EXIT_FAILURE;
		}

		sprintf(command, "%s \"+%s\"", command, argv[1]);
	}

#ifdef DEBUG
	fprintf(stderr, "Command: %s\n", command);
#endif

	printf("Last team who got the flag read it at:\n");
	system(command);

	return EXIT_SUCCESS;
}
