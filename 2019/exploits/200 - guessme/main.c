#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/random.h>

#define SIZE 0x20

char filename[] = "/tmp/guessme-XXXXXX";

void __attribute__((constructor)) ctor(void)
{
	int  fd           = -1;
	char random[SIZE] = {0};

	/* You're going to hate this syscall */
	if(sizeof(random) != getrandom(&random, sizeof(random), 0)) {
		perror("getrandom");
		exit(EXIT_FAILURE);
	}

	/* Create random file, o=rw,go= */
	if(0 > (fd = mkstemp(filename))) {
		perror("mkstemp");
		exit(EXIT_FAILURE);
	}

	/* Write content of random file */
	if(sizeof(random) != write(fd, random, sizeof(random))) {
		perror("write");
		exit(EXIT_FAILURE);
	}

	/* Close it */
	if(0 != close(fd)) {
		perror("close");
		exit(EXIT_FAILURE);
	}
}

void __attribute__((destructor)) dtor(void)
{
	if(0 != unlink(filename))
		perror("unlink");
}

/* Somewhat hacky, but it works -- does not handle stupid users */
static inline char nibble(char c)
{
	if('0' <= c && c <= '9')
		return c - '0';

	return (c & 0x0F) + 9;
}

int main(int argc, char *argv[])
{
	int    fd           = open(filename, O_RDONLY);
	char   secret[SIZE] = {0};

	size_t i      = 0;
	char   byte   = 0;
	int    c1, c2 = 0;

	/* Read it again */
	read(fd, secret, sizeof(secret));
	close(fd);

	/* I told you I would write reverse, pwn and guessing tasks */
	printf("What is the content of file %s (in hex)?\n", filename);
	for(i = 0; i < sizeof(secret); i++) {
		byte = (nibble(getchar()) << 4) | nibble(getchar());

		if(byte != secret[i]) {
			puts("Nope ;-(");
			return EXIT_FAILURE;
		}
	}

	/* Those who reach here probably already guessed the flag... */
	setregid(getegid(), getegid());
	system("/bin/sh");
	return EXIT_SUCCESS;
}
