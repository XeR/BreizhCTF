#!/bin/sh
# GID = elevated gid
readonly GID=1001

# -r--r-----  1 root root    51 Apr 15  2018 flag.txt
# -r--r--r--  1 root root   211 Apr 15  2018 Makefile
# -r--r--r--  1 root root   658 Apr 15  2018 metadata.c
# -r--r--r--  1 root root   295 Apr 15  2018 metadata.h
# -rwxrwxrwx  1 root root  1310 Apr  4 14:19 perms.sh
# -r--r--r--  1 root root    85 Apr 15  2018 rsa.h
# -r--r--r--  1 root root  2355 Apr 15  2018 rsa_public.c
# -r-xr-sr-x  1 root 1001 19296 Apr  4 14:17 safeRun
# -r--r--r--  1 root root  2948 Apr  4 14:04 safeRun.c
# dr-xr-xr-x  2 root 1001  4096 Apr 15  2018 scripts
# -r--r--r--  1 root root  1212 Apr 15  2018 sign.c

# -r-xr-xr-x 1 root 1001  23 Apr 15  2018 id.sh
# -r--r--r-- 1 root 1001 336 Apr  4 14:23 id.sh.metadata
# -r-xr-xr-x 1 root 1001 326 Apr 15  2018 secret.sh
# -r--r--r-- 1 root 1001 336 Apr  4 14:23 secret.sh.metadata
# -r--r----- 1 root 1001  31 Apr 15  2018 secret.txt

# cd to make sure we don't accidentally fuck up every perms
cd "$(dirname "$0")"

# Everything belongs to root by default
chown -R 0:0 .

# Those files have pwn gid
chown -R ":$GID" safeRun scripts flag.txt rsa_private.c

# Files default rights : r--r--r--
find -type f -print0 | xargs -0 chmod a=r

# Make directories rx
chmod a=rx . scripts

# Binary is sgid, executable by everyone
chmod a=rx,g+s safeRun

# Scripts can be executed by everyone
chmod a=rx -- scripts/*.sh

# secret.txt and flag.txt are only readable by pwn
chmod ug=r,o= scripts/secret.txt flag.txt rsa_private.c sign

[ -f "sign" ] && echo "Do not forget to remove sign before release"
