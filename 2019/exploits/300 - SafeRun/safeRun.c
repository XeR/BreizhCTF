#include "metadata.h"
#include "rsa.h"

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <assert.h>

#include <openssl/evp.h>
#include <openssl/err.h>

extern char **environ;

void __attribute__((noreturn)) xerror(char *msg)
{
	unsigned long e = ERR_get_error();

	fprintf(stderr, "%s\n", msg);
	fprintf(stderr, "[%lu] %s\n", e, ERR_error_string(e, NULL));

	abort();
}

int readMetadata(char *binary, struct metadata *m)
{
	FILE *fp;
	char name[1024];

	/* Prepare name */
	strncpy(name, binary,      sizeof(name) - 1);
	strncat(name, ".metadata", sizeof(name) - 1);

	/* Open and read metadata */
	if(NULL == (fp = fopen(name, "r")))
		return -1;

	if(1 != fread(m, sizeof(struct metadata), 1, fp)) 
		return -2;

	fclose(fp);
	return 0;
}

int readHash(char *binary, unsigned char *md)
{
	SHA512_CTX ctx;
	int        fd;
	char       buffer[1024];
	ssize_t    size;

	/* Open file */
	if(0 > (fd = open(binary, O_RDONLY)))
		return -1;

	/* Get its hash */
	SHA512_Init(&ctx);

	while(0 < (size = read(fd, buffer, sizeof(buffer))))
		SHA512_Update(&ctx, buffer, size);

	SHA512_Final(md, &ctx);

	/* Keep fd open to prevent race conditions ;-) */
	return fd;
}

int main(int argc, char *argv[])
{
	EVP_MD_CTX *ctx;

	time_t   now;
	struct   metadata m;
	size_t   size;

	int      fd;
	unsigned char md[SHA512_DIGEST_LENGTH];

	if(argc < 2) {
		fprintf(stderr, "Usage: %s [binary]\n", argv[0]);
		fprintf(stderr, "Runs a signed script or binary with elevated"
			"privileges (gid = %d, egid = %d)", getgid(), getegid()
		);

		return EXIT_FAILURE;
	}

	/* Prepare variables */
	ctx  = EVP_MD_CTX_new();
	size = sizeof(m.signature);
	now  = time(NULL);

	/* Read file from stdin and calculate its hash */
	if(0 != readMetadata(argv[1], &m)) {
		perror("readMetadata");
		return EXIT_FAILURE;
	}

	/* Check date beforehand (save some CPU cycles) */
	if(now < m.start) {
		fprintf(stderr, "Signature not valid yet\n");
		return EXIT_FAILURE;
	}

	if(m.end < now) {
		fprintf(stderr, "Expired signature\n");
		return EXIT_FAILURE;
	}

	/* Check the hash */
	fd = readHash(argv[1], md);
	if(0 != strncmp((char*)m.hash, (char*)md, sizeof(md))) {
		fprintf(stderr, "Invalid hash\n");
		return EXIT_FAILURE;
	}

	/* Check the signature */
	if(1 != EVP_DigestVerifyInit(ctx, NULL, EVP_sha512(), NULL, rsa_get()))
		xerror("EVP_DigestVerifyInit");

	if(1 != EVP_DigestVerifyUpdate(ctx, &m, sizeof(m) - size))
		xerror("EVP_DigestVerifyUpdate");

	if(1 != EVP_DigestVerifyFinal(ctx, m.signature, size))
		xerror("EVP_DigestVerifyFinal");

	/* Free resources */
	EVP_MD_CTX_free(ctx);
	rsa_free();

	/* Elevate privileges (don't do this at home, we are professionals) */
	if(0 != setregid(getegid(), getegid())) {
		perror("setregid");
		return EXIT_FAILURE;
	}

	/* Rewind file and execute it */
	lseek(fd, 0, SEEK_SET);
	fexecve(fd, argv + 1, environ);

	perror("fexecve");

	return EXIT_FAILURE;
}
