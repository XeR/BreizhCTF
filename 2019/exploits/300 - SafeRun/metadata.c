#include "metadata.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <openssl/sha.h>

void metadata_prepare(struct metadata *m, FILE *fp)
{
	int c;
	SHA512_CTX ctx;

	/* Sign the program for a whole year (until Breizh CTF 2019 ;-) ) */
	m->start = time(NULL);
	m->end   = m->start + 60 * 60 * 24 * 365;

	/* Read file and update hash */
	SHA512_Init(&ctx);

	while(EOF != (c = getc(fp)))
		SHA512_Update(&ctx, &c, 1);

	SHA512_Final(m->hash, &ctx);

	/* Set signature to 0 */
	memset(m->signature, 0, sizeof(m->signature));
}

int metadata_read(struct metadata *m, FILE *fp)
{
	return fread((void*)m, sizeof(struct metadata), 1, fp);
}
