#include "metadata.h"
#include "rsa.h"

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>

#include <openssl/evp.h>
#include <openssl/err.h>

void __attribute__((noreturn)) xerror(char *msg)
{
	unsigned long e = ERR_get_error();

	fprintf(stderr, "%s\n", msg);
	fprintf(stderr, "[%lu] %s\n", e, ERR_error_string(e, NULL));

	abort();
}

int main(int argc, char *argv[])
{
	EVP_MD_CTX *ctx;

	struct metadata m;
	size_t size;

	/* Avoid compiler warnings */
	(void)argc;
	(void)argv;

	/* Prepare variables */
	ctx  = EVP_MD_CTX_new();
	size = sizeof(m.signature);

	/* Read file from stdin and calculate its hash */
	metadata_prepare(&m, stdin);

	/* Sign the metadata */
	if(1 != EVP_DigestSignInit(ctx, NULL, EVP_sha512(), NULL, rsa_get()))
		xerror("EVP_DigestSignInit");

	if(1 != EVP_DigestSignUpdate(ctx, &m, sizeof(m) - size))
		xerror("EVP_DigestSignUpdate");

	if(1 != EVP_DigestSignFinal(ctx, m.signature, &size))
		xerror("EVP_DigestSignFinal");

	/* Ensure its size is ok */
	assert(size == sizeof(m.signature));

	/* Output the metadata content */
	write(STDOUT_FILENO, &m, sizeof(m));

	/* Free resources */
	EVP_MD_CTX_free(ctx);
	rsa_free();

	return EXIT_SUCCESS;
}
